<!-- templates/admin_dashboard.html -->
{% extends "base.html" %}
{% block content %}
<div class="dashboard admin-dashboard">
    <h2>All Support Requests</h2>
    
    <div id="stats-graph"></div>
    
    <div class="requests-list">
        {% for request in requests %}
        <div class="request-card {% if request.status == 'solved' %}solved{% endif %}">
            <div class="request-header">
                <h3>{{ request.problem_type }} Issue</h3>
                <span class="status">{{ request.status }}</span>
            </div>
            
            <div class="request-details">
                <p>Submitted by: {{ request.user.full_name }}</p>
                <p>Location: {{ request.location_type }} {{ request.location_number }}</p>
                <p>Date: {{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                <p>{{ request.description }}</p>
                
                {% if request.image_path %}
                <img src="{{ url_for('static', filename='uploads/' + request.image_path) }}" alt="Issue Image" class="request-image">
                {% endif %}
            </div>
            
            {% if request.status != 'solved' %}
            <form method="POST" action="{{ url_for('main.solve_request', request_id=request.id) }}" class="solve-form">
                <button type="submit">Mark as Solved</button>
            </form>
            {% endif %}
            
            <div class="messages">
                <h4>Messages</h4>
                {% for message in request.messages %}
                <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                    <p>{{ message.content }}</p>
                    <small>{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                {% endfor %}
                
                <form method="POST" action="{{ url_for('main.add_message', request_id=request.id) }}" class="message-form">
                    <input type="text" name="content" placeholder="Type your message..." required>
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    {% if graph_json %}
    const graphData = {{ graph_json | safe }};
    Plotly.newPlot('stats-graph', graphData.data, graphData.layout);
    {% endif %}
</script>
{% endblock %}